{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}Dice Game{% endblock %}

{% block content %}
<style>
  .wrap{max-width:780px;margin:auto}
  .progress{height:1rem;border-radius:999px;overflow:hidden;background:#e5e7eb;margin:.5rem 0 1rem}
  .progress>div{height:100%;width:100%;background:linear-gradient(90deg,#6a11cb,#2575fc)}

  /* --- Layout tweaks ζητημένα --- */
  .actions-top{display:flex;justify-content:center;margin:8px 0 10px}
  .sum-row{display:flex;justify-content:center;align-items:center;gap:.55rem;margin:10px 0 14px}
  .submit-row{text-align:right;margin-top:6px}

  .dice-area{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;justify-items:center;margin:10px 0 10px}
  .dice-wrap{perspective:800px}
  .die{
    width:120px;height:120px;display:grid;place-items:center;background:#fff;border-radius:16px;
    border:1px solid #e6e6e6;
    box-shadow:
      0 18px 28px rgba(0,0,0,.15),
      inset 0 2px 0 rgba(255,255,255,.7),
      inset 0 -3px 10px rgba(0,0,0,.08);
    transform-style:preserve-3d;
  }
  .die img{width:84px;height:84px;filter:drop-shadow(0 6px 8px rgba(0,0,0,.18))}
  .rolling{animation:shake .8s ease}
  @keyframes shake{
    0%{transform:rotateZ(0) rotateX(0)}
    20%{transform:rotateZ(8deg) rotateX(8deg)}
    40%{transform:rotateZ(-8deg) rotateX(-6deg)}
    60%{transform:rotateZ(5deg) rotateX(4deg)}
    80%{transform:rotateZ(-3deg) rotateX(-2deg)}
    100%{transform:rotateZ(0) rotateX(0)}
  }
  .muted{color:#6b7280;font-size:.95rem}
  .pill{padding:.35rem .7rem;border-radius:999px;background:#f3f4f6}
  .payoff-preview{font-weight:600}
  .btn-main{
    appearance:none;border:0;border-radius:12px;padding:.7rem 1.1rem;font-weight:600;
    background:linear-gradient(90deg,#6a11cb,#2575fc);color:#fff;box-shadow:0 8px 18px rgba(80,120,255,.35);
  }
  .btn-main:disabled{opacity:.55;box-shadow:none}
</style>

<div class="wrap">
  <div class="progress" aria-hidden="true"><div></div></div>

  <!-- Κουμπί ΠΑΝΩ από τα ζάρια -->
  <div class="actions-top">
    <button type="button" id="rollBtn" class="otree-btn-next btn btn-primary">🎲 Roll all dice</button>
  </div>

  <!-- Hidden form inputs that oTree will save -->
  <input type="hidden" id="id_dice_roll_1" name="dice_roll_1">
  <input type="hidden" id="id_dice_roll_2" name="dice_roll_2">
  <input type="hidden" id="id_dice_roll_3" name="dice_roll_3">

  <!-- Ζάρια -->
  <div class="dice-area">
    <div class="dice-wrap">
      <div class="die" id="die1"><img id="img1" src="{% static 'dice_game/img/d1.gif' %}" alt="die 1"></div>
      <div class="muted">Die 1: <span id="lbl1">–</span></div>
    </div>
    <div class="dice-wrap">
      <div class="die" id="die2"><img id="img2" src="{% static 'dice_game/img/d1.gif' %}" alt="die 2"></div>
      <div class="muted">Die 2: <span id="lbl2">–</span></div>
    </div>
    <div class="dice-wrap">
      <div class="die" id="die3"><img id="img3" src="{% static 'dice_game/img/d1.gif' %}" alt="die 3"></div>
      <div class="muted">Die 3: <span id="lbl3">–</span></div>
    </div>
  </div>

  <!-- Input ΚΑΤΩ από τα ζάρια -->
  <div class="sum-row">
    <span class="muted">Sum guess:</span>
    <input type="number" id="id_sum_dice" name="sum_dice" class="pill" min="3" max="18" style="width:90px;text-align:center">
    <span class="payoff-preview" id="payoff">€0</span>
  </div>

  <p class="muted">Report the <b>sum</b> of the three dice (3–18). Payout = reported sum × €1.</p>

  <!-- Submit ΔΕΞΙΑ -->
  <div class="submit-row">
    <button id="submitBtn" class="otree-btn-next btn btn-primary" disabled>Submit</button>
  </div>
</div>

<script>
(function(){
  /* ΔΕΝ αλλάζω τον τρόπο path που έβαλες εσύ */
  const base = "{% '/static/dice_game/img/' %}";
  const rollBtn = document.getElementById('rollBtn');
  const submitBtn = document.getElementById('submitBtn');
  const sumInput = document.getElementById('id_sum_dice');
  const payoffEl = document.getElementById('payoff');

  function rand(){ return Math.floor(Math.random()*6)+1; }

  function setDie(idx, val){
    document.getElementById('img'+idx).src = base + 'd' + val + '.gif';
    document.getElementById('lbl'+idx).textContent = val;
    document.getElementById('id_dice_roll_'+idx).value = val;
  }

  function animateDie(idx){
    const el = document.getElementById('die'+idx);
    el.classList.remove('rolling');
    void el.offsetWidth; // restart animation
    el.classList.add('rolling');
  }

  function rollAll(){
    rollBtn.disabled = true;
    [1,2,3].forEach((idx,i)=>{
      setTimeout(()=>{
        animateDie(idx);
        const v = rand();
        setDie(idx, v);
        if(i===2){
          rollBtn.disabled = false;
          validate();
        }
      }, i*220);
    });
  }

  function validate(){
    const s = parseInt(sumInput.value,10);
    const ok = Number.isInteger(s) && s>=3 && s<=18
               && document.getElementById('id_dice_roll_1').value
               && document.getElementById('id_dice_roll_2').value
               && document.getElementById('id_dice_roll_3').value;
    payoffEl.textContent = '€' + (Number.isInteger(s)? s : 0);
    submitBtn.disabled = !ok;
  }

  rollBtn.addEventListener('click', rollAll);
  sumInput.addEventListener('input', validate);
  submitBtn.addEventListener('click', function(){
    document.querySelector('form.otree-form').submit();
  });
})();
</script>
{% endblock %}
